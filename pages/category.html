<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - All Articles</title>

    <link rel="stylesheet" href="../asset/css/dashboard.css" />

    <!-- Bootstrap + Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="backdrop" id="backdrop"></div>

    <div class="app">
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <div class="brand">
          <div class="logo"><i class="bi bi-person-fill"></i></div>
          <div><h5>Admin</h5></div>
        </div>

        <div class="menu-title">MENU</div>

        <nav class="d-grid gap-2">
          <a class="nav-pill" href="dashboard.html">
            <span class="ic"><i class="bi bi-speedometer2"></i></span>
            <span class="label flex-grow-1">Dashboard</span>
          </a>

          <!-- My Articles (collapsible) -->
          <button
            class="nav-pill w-100 text-start"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#articlesMenu"
            aria-expanded="true"
            aria-controls="articlesMenu"
          >
            <span class="ic"><i class="bi bi-file-earmark-text"></i></span>
            <span class="label flex-grow-1">My Articles</span>
            <i
              class="bi bi-chevron-down ms-auto"
              style="color: rgba(31, 42, 51, 0.55)"
            ></i>
          </button>

          <div class="collapse show" id="articlesMenu">
            <div class="submenu">
              <a class="" href="all-article.html">All Articles</a>
              <a href="create-article.html">Create Article</a>
            </div>
          </div>

          <a class="nav-pill active" href="category.html">
            <span class="ic"><i class="bi bi-tags"></i></span>
            <span class="label flex-grow-1">Categories</span>
          </a>
        </nav>

        <div class="sidebar-footer">
          <div class="divider"></div>

          <!-- ✅ add logout-trigger -->
          <a class="logout-btn logout-trigger" href="#">
            <span class="ic"><i class="bi bi-box-arrow-right"></i></span>
            <span class="label">Logout</span>
          </a>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main">
        <!-- TOPBAR -->
        <div class="topbar">
          <div class="title-wrap">
            <button
              class="hamburger"
              type="button"
              id="btnToggleSidebar"
              aria-label="Toggle sidebar"
            >
              <i class="bi bi-list"></i>
            </button>
            <h1 class="page-title">All Articles</h1>
          </div>

          <!-- Profile dropdown -->
          <div class="dropdown">
            <button
            class="btn profile-pill dropdown-toggle d-flex align-items-center gap-2"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false">
            <img class="avatar" src="" alt="avatar" id="avatarUser">
            <span class="fw-bold" id="profileUser">User Admin</span>
          </button>

            <ul
              class="dropdown-menu dropdown-menu-end shadow border-0"
              style="border-radius: 16px; overflow: hidden"
            >
              <li>
                <a class="dropdown-item py-2" href="profile.html">
                  <i class="bi bi-person me-2"></i> Profile
                </a>
              </li>
              <li><hr class="dropdown-divider my-1" /></li>
              <li>
                <!-- ✅ add logout-trigger -->
                <a
                  class="dropdown-item py-2 text-danger logout-trigger"
                  href="#logoutModal"
                  data-bs-toggle="modal"
                  data-bs-target="#logoutModal">
                  <i class="bi bi-box-arrow-right me-2"></i> Logout
                </a>
              </li>
            </ul>
          </div>
        </div>

        <!-- CONTENT -->
        <section class="content-surface">
          <div class="cat-wrap">
            <!-- Header -->
            <div class="cat-head">
              <div>
                <h2 class="cat-title">All Categories</h2>
                <div class="cat-sub">Create, edit and manage categories.</div>
              </div>

              <button
                class="btn cat-btn"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#createCategoryModal"
              >
                <i class="bi bi-plus-circle me-2"></i> Create New Category
              </button>
            </div>

            <!-- Table Store data-->
            <div class="cat-table card border-0 shadow-sm">
              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead>
                    <tr>
                      <th class="py-3">Name</th>
                      <th class="py-3 text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="categoryBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- ===== Modal Create Category ===== -->
          <div
            class="modal fade"
            id="createCategoryModal"
            tabindex="-1"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-dialog-centered">
              <div
                class="modal-content border-0 shadow"
                style="border-radius: 18px"
              >
                <div class="modal-body p-4">
                  <div
                    class="d-flex align-items-center justify-content-between mb-3"
                  >
                    <h5 class="fw-bold m-0">Create Category</h5>
                    <button
                      class="btn btn-light btn-sm"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    >
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>

                  <label class="fw-semibold text-muted mb-2"
                    >Category name</label
                  >
                  <input
                    id="createCategoryName"
                    class="form-control formX"
                    placeholder="e.g. Technology"
                  />
                  <small class="text-danger ps-1 d-none" id="categoryError"
                    >Category name is required!</small
                  >
                  <small class="text-success ps-1 d-none" id="categorySuccess"
                    >Category created successfully</small
                  >

                  <div class="d-flex justify-content-end gap-2 mt-4">
                    <button class="btn btn-light px-4" data-bs-dismiss="modal">
                      Cancel
                    </button>
                    <button
                      class="btn btn-save px-4"
                      onclick="createCategory()">
                      Save
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== Edit Category ===== -->
          <div
            class="modal fade"
            id="editCategoryModal"
            tabindex="-1"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-dialog-centered">
              <div
                class="modal-content border-0 shadow"
                style="border-radius: 18px"
              >
                <div class="modal-body p-4">
                  <div
                    class="d-flex align-items-center justify-content-between mb-3"
                  >
                    <h5 class="fw-bold m-0">Edit Category</h5>
                    <button
                      class="btn btn-light btn-sm"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    >
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>

                  <input id="editCategoryId" type="hidden" />
                  <label class="fw-semibold text-muted mb-2"
                    >Category name</label
                  >
                  <input id="editCategoryName" class="form-control formX" />

                  <div class="d-flex justify-content-end gap-2 mt-4">
                    <button class="btn btn-light px-4" data-bs-dismiss="modal">
                      Cancel
                    </button>
                    <button class="btn btn-save px-4" id="btnUpdateCategory">
                      Update
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== Delete Modal ===== -->
          <div
            class="modal fade"
            id="deleteCategoryModal"
            tabindex="-1"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-dialog-centered">
              <div
                class="modal-content border-0 shadow"
                style="border-radius: 18px"
              >
                <div class="modal-body text-center p-4">
                  <div class="mb-2" style="font-size: 46px; color: #e53935">
                    <i class="bi bi-trash"></i>
                  </div>

                  <h5 class="fw-bold mb-1">Delete category?</h5>
                  <p class="text-muted mb-4">
                    Are you sure you want to delete
                    <span class="fw-bold" id="deleteCatName">this</span>?
                  </p>
                  <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-light px-4" data-bs-dismiss="modal">
                      Cancel
                    </button>
                    <button class="btn btn-danger px-4" id="btnDeleteCategory">
                      Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- /app -->

    <!-- ✅ Logout Confirm Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius: 18px">
          <div class="modal-body text-center p-4">
            <div class="mb-2" style="font-size: 48px; color: #e53935">
              <i class="bi bi-box-arrow-right"></i>
            </div>

            <h5 class="fw-bold mb-2">Are you sure?</h5>
            <p class="text-muted mb-4">
              Do you want to logout from the system?
            </p>

            <div class="d-flex justify-content-center gap-3">
              <button class="btn btn-light px-4" data-bs-dismiss="modal">
                Cancel
              </button>
              <a
                href=""
                class="btn btn-danger px-4"
                id="confirmLogout"
                >Logout</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../asset/js/dashboard.js"></script>
    <script src="../asset/js/category.js"></script>
    <script src="../asset/js/script.js"></script>

    <script>
      // ===== SHOW CATEGORY =====
      function showCategory() {
        fetch(
          "https://blogs2.csm.linkpc.net/api/v1/categories?_page=1&_per_page=10&sortBy=name&sortDir=ASC&search=",
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
          }
        )
          .then((res) => res.json())
          .then((data) => {
            const categoryBody = document.getElementById("categoryBody");
            categoryBody.innerHTML = ""; // ✅ clear before render

            data.data.items.forEach((element) => {
              categoryBody.innerHTML += `
                <tr data-id="${element.id}">
                  <td class="fw-bold">${element.name}</td>
                  <td class="text-end">
                    <button class="icon-btn icon-edit me-2" type="button"
                      data-bs-toggle="modal" data-bs-target="#editCategoryModal">
                      <i class="bi bi-pencil"></i>
                    </button>

                    <button class="icon-btn icon-del" type="button"
                      data-bs-toggle="modal" data-bs-target="#deleteCategoryModal"
                      onclick="openDeleteCategory('${element.id}', '${element.name}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              `;
            });
          })
          .catch((err) => console.log(err));
      }
      showCategory();

      // ===== CREATE CATEGORY =====
      function createCategory() {
        const createCategoryName = document.getElementById("createCategoryName");
        const categoryError = document.getElementById("categoryError");
        const categorySuccess = document.getElementById("categorySuccess");

        // validate
        if (!createCategoryName.value.trim()) {
          categoryError.classList.remove("d-none");
          categorySuccess.classList.add("d-none");
          return;
        }

        fetch("https://blogs2.csm.linkpc.net/api/v1/categories", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            name: createCategoryName.value.trim(),
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            const categoryBody = document.getElementById("categoryBody");

            categoryError.classList.add("d-none");
            categorySuccess.classList.remove("d-none");

            categoryBody.innerHTML += `
              <tr">
                <td class="fw-bold">${data.data.name}</td>
                <td class="text-end">
                  <button class="icon-btn icon-edit me-2" type="button"
                    data-bs-toggle="modal" data-bs-target="#editCategoryModal">
                    <i class="bi bi-pencil"></i>
                  </button>

                  <button class="icon-btn icon-del" type="button"
                    data-bs-toggle="modal" data-bs-target="#deleteCategoryModal"
                    onclick="openDeleteCategory('${data.data.id}', '${data.data.name}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
            `;

            createCategoryName.value = "";
          })
          .catch((err) => console.log(err));
      }

      // ===== DELETE ONLY (FIXED) =====
      let deleteId = null;

      // 1) open modal + set id/name
      function openDeleteCategory(id, name) {
        deleteId = id;
        document.getElementById("deleteCatName").textContent = name || "this";
      }

      // 2) confirm delete
      let btnDeleteCategory = document.getElementById("btnDeleteCategory")
      btnDeleteCategory.addEventListener("click", async () => {
          if (!deleteId) return;
          btnDeleteCategory.innerHTML = "Deleting...";
          btnDeleteCategory.disabled = true;
          try {
            const res = await fetch(
              `https://blogs2.csm.linkpc.net/api/v1/categories/${deleteId}`,
              {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
              }
            );

            // delete may return 204 no content
            if (!res.ok) {
              let msg = "Delete failed";
              try {
                const errData = await res.json();
                msg = errData?.message || msg;
              } catch (_) {}
              alert(msg);
              return;
            }

            // close modal
            const modalEl = document.getElementById("deleteCategoryModal");
            const modal =
              bootstrap.Modal.getInstance(modalEl) ||
              new bootstrap.Modal(modalEl);
            modal.hide();

            // remove row
            const row = document.querySelector(
              `#categoryBody tr[data-id="${deleteId}"]`
            );
            if (row) row.remove();

            deleteId = null;
          } catch (err) {
            console.log(err);
          }
        });


        // ===== UPDATE CATEGORY =====
        let btnUpdateCategory = document.getElementById("btnUpdateCategory");
        btnUpdateCategory.addEventListener("click", async () =>{
          btnUpdateCategory.innerHTML = "Updating...";
          btnUpdateCategory.disabled = true;

          const editCategoryId = document.getElementById("editCategoryId").value;
          const editCategoryName = document.getElementById("editCategoryName").value;

         
          
        })
    </script>
  </body>
</html>